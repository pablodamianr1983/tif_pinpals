<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultar Servidor</title>
</head>
<body>

<form id="searchForm">
    <label for="search">Buscar Servidor:</label>
    <input type="text" id="search" placeholder="Nombre o ID del servidor">
    <button type="submit">Buscar</button>
</form>

<h2>Detalles del Servidor:</h2>
<div id="serverDetails"></div>

<h2>Canales asociados:</h2>
<ul id="channelsList"></ul>

<script>
    document.getElementById("searchForm").addEventListener("submit", async function(e){
        e.preventDefault();
        const searchTerm = document.getElementById("search").value;

        // Llamamos a la API para buscar el servidor
        let response = await fetch(`http://127.0.0.1:5000/servers/search?term=${searchTerm}`);
        let data = await response.json();

        if (data && data.length > 0) {
            const server = data[0];
            document.getElementById("serverDetails").innerText = `Nombre: ${server.Name}, Propietario: ${server.OwnerID}`;
            
            // Llamamos a la API para obtener los canales de ese servidor
            response = await fetch(`http://127.0.0.1:5000/channels/by_server/${server.ID}`);
            const channels = await response.json();

            const channelsList = document.getElementById("channelsList");
            channelsList.innerHTML = ''; // Limpiar la lista actual

            for (const channel of channels) {
                const li = document.createElement("li");
                li.innerText = channel.Name;

                // Llamamos a la API para obtener los usuarios que dejaron mensajes en ese canal
                const usersUl = document.createElement("ul");
                li.appendChild(usersUl);
                channelsList.appendChild(li);

                fetch(`http://127.0.0.1:5000/messages/users_by_channel/${channel.ID}`)
                    .then(response => response.json())
                    .then(usersData => {
                        for (const user of usersData) {
                            const userLi = document.createElement("li");
                            userLi.innerText = user.Username;
                            usersUl.appendChild(userLi);
                        }
                    });
            }
        } else {
            document.getElementById("serverDetails").innerText = "No se encontr√≥ el servidor.";
            document.getElementById("channelsList").innerHTML = '';
        }
    });

</script>

</body>
</html>
